# 憲法與模板分層指南

## 📋 文檔目的

本指南說明在 Specification-Driven Development (SDD) 流程中，如何正確區分和組織不同層級的規範文件，包括憲法（Constitution）、模板（Templates）、計畫（Plan）和任務（Tasks）。

---

## 🎯 核心概念

### 三層架構原則

在 SDD 流程中，規範文件分為三個層級：

```
┌─────────────────────────────────────────┐
|         憲法 (Constitution)              |  ← 不可協商的原則
├─────────────────────────────────────────┤
|         模板 (Templates)                 |  ← 可重複使用的最佳實務
├─────────────────────────────────────────┤
|   計畫 & 任務 (Plan & Tasks)             |  ← 功能特定的具體實作
└─────────────────────────────────────────┘
```

### 關鍵區別

| 層級 | 定位 | 可否被覆寫 | 內容範圍 |
|------|------|-----------|---------|
| **憲法** | 團隊工作原則 | ❌ 不可 | 跨專案、跨功能的 MUST 級規範 |
| **模板** | 最佳實務範式 | ✅ 可以 | 可重複使用的模式與指導 |
| **Plan/Tasks** | 功能實作 | ✅ 可以 | 單一功能的具體執行步驟 |

---

## 📖 第一部分：憲法的定位與範圍

### 1.1 什麼應該寫入憲法？

**原則：只放「不可被個別 feature 覆蓋」的規範（MUST 級別）**

#### ✅ 適合放入憲法的內容

- **開發流程原則**
  - 例：「測試必須先於實作完成（TDD）」
  - 例：「所有架構決策必須有文檔追溯性」

- **架構一致性要求**
  - 例：「共用元件必須以可重複使用的方式設計」
  - 例：「資料驗證邏輯不得散落於控制器層」

- **品質門檻**
  - 例：「程式碼覆蓋率不得低於 80%」
  - 例：「所有 API 端點必須有整合測試」

- **安全性基線**
  - 例：「敏感資料必須加密儲存」
  - 例：「使用者輸入必須經過驗證與消毒」

#### ❌ 不應放入憲法的內容

- **具體操作步驟** → 應放入 Templates 或 Tasks
- **框架特定語法** → 應放入 Templates
- **單一功能的需求** → 應放入 Plan/Tasks
- **可選的最佳實務** → 應放入 Templates（標註為 SHOULD）

### 1.2 如何避免憲法過於肥大？

**原則：憲法保持在「原則層級」，不包含「操作層級」**

#### 精簡策略

1. **只保留 MUST 級規範**
   - 將 SHOULD、MAY 級別的建議移至 Templates

2. **原則與做法分離**
   ```
   ✅ 憲法：「所有 CRUD 操作必須保持一致性」
   ❌ 憲法：「建立資源時，依序執行：建立 Model → 建立 Controller → 建立 View」

   → 後者應放入 Templates
   ```

3. **使用引用而非複製**
   - 憲法可引用模板，但不重複其內容
   - 例：「UI 元件開發遵循 `/templates/component-development.md`」

---

## 📖 第二部分：文件流程與讀取時機

### 2.1 各階段讀取的文件

|   階段      |  Specify    |   Plan       |  Implement   |
|------|------|-----------|---------|
| 讀取憲法？   |    ❌       |     ✅       |     ❌       |
| 讀取模板？   |    ✅       |     ✅       |     ❌       |
| 讀取 Spec?   |    -        |     ✅       |     ✅       |
| 讀取 Plan?   |    ❌       |     -        |     ✅       |
| 讀取 Tasks?  |    ❌       |     ❌       |     ✅       |


### 2.2 為何 Implement 階段不讀憲法？

**原因：憲法約束已在 Plan 階段套用完畢**

- `/speckit.plan` 會讀取憲法並將約束轉化為設計決策
- `/speckit.analyze` 會檢查 Plan 是否違反憲法
- `/speckit.implement` 只需執行經過驗證的 Tasks

這避免了重複驗證，並確保實作階段專注於執行而非規範檢查。

---

## 📖 第三部分：如何拆分混合文件

### 3.1 問題場景

當你有一份文件包含：
- 原則聲明
- 最佳實務範例
- 具體實作步驟
- 框架特定細節

該如何拆分到正確的位置？

### 3.2 三步拆分法

#### 步驟 1：識別內容類型

逐段標記文件內容：
- `[P]` Principle（原則）
- `[B]` Best Practice（最佳實務）
- `[S]` Specific Step（具體步驟）
- `[E]` Example（範例）

#### 步驟 2：按類型分配目標

```
[P] → Constitution  （如果是 MUST 級）
[P] → Templates     （如果是 SHOULD/MAY 級）
[B] → Templates
[S] → Plan/Tasks    （如果是功能特定）
[S] → Templates     （如果是可重複流程）
[E] → Templates/Checklist
```

#### 步驟 3：重寫為對應格式

##### 範例：原始混合文件

```
原則：所有後台管理功能應保持一致性
原則：表單欄位不得在控制器內硬寫
範例：使用 Resource Pattern 來管理 CRUD
步驟：建立 Resource → 建立頁面 → 設定表格 → 設定表單
細節：產品模組需要額外的庫存欄位
細節：需要自訂批次操作
```

##### 拆分結果

**→ Constitution** (constitution.md)
```markdown
## UI 架構原則
- 所有共用 UI 元件必須以可重複使用的方式設計（MUST）
- 資料驗證邏輯不得散落於控制器層（MUST）
- 後台 CRUD 流程必須能被自動生成並保持一致性（SHOULD）
```

**→ Template** (/templates/backend-crud-pattern.md)
```markdown
## 後台 CRUD 開發模式

### 標準流程
1. 建立資源定義（Resource）
2. 建立頁面（List/Create/Edit）
3. 設定資料表格欄位
4. 設定表單欄位

### 典型結構
\`\`\`
/Resources
  └── {Entity}Resource.php
/Pages
  ├── List{Entity}.php
  ├── Create{Entity}.php
  └── Edit{Entity}.php
\`\`\`

### 檢查清單
- [ ] 所有欄位均在表單層定義
- [ ] 不在控制器內寫重複邏輯
- [ ] CRUD 頁面使用統一的資源模式
```

**→ Plan** (plan.md)
```markdown
## 產品管理功能設計

### 架構決策
本功能使用後台 CRUD 模式（見 `/templates/backend-crud-pattern.md`）

### 功能需求
- 需要 List/Create/Edit 三個頁面
- 表格需顯示庫存數量（stock）
- 表單需支援變體重複輸入（variants repeater）
```

**→ Tasks** (tasks.md)
```markdown
## 產品管理任務清單

- [ ] 建立 ProductResource
- [ ] 在資料表格中加入 stock 欄位
- [ ] 在表單中加入 variants 重複輸入元件
- [ ] 設定批次刪除操作
- [ ] 撰寫產品 CRUD 測試
```

---

## 📖 第四部分：Plan vs Tasks vs Templates

### 4.1 核心區別

| 文件類型 | 主要問題 | 內容性質 | 範例 |
|---------|---------|---------|------|
| **Plan** | 要做什麼？為什麼？怎麼設計？ | 設計決策與架構 | "使用事件驅動架構處理訂單流程" |
| **Tasks** | 有哪些可驗收的工作？ | 可執行任務（0.5-2天） | "實作 OrderCreated 事件處理器" |
| **Templates** | 怎麼做？有什麼模式？ | 指導步驟與範例 | "事件處理器實作步驟：1. 建立類別 2. 註冊監聽..." |

### 4.2 判斷準則

#### ✅ 應該寫在 Plan 的內容

- 功能目標與成功準則
- 架構設計決策（選擇什麼模式/技術）
- 風險評估與緩解策略
- 工作拆分的理由
- **引用**使用的模板（不複製內容）

範例：
```markdown
## 設計決策
本功能採用 CQRS 模式分離讀寫操作，理由：
- 讀取頻率遠高於寫入（10:1）
- 需要複雜的報表查詢
- 寫入需要嚴格的事務一致性

實作將遵循 `/templates/cqrs-pattern.md` 範式。
```

#### ✅ 應該寫在 Tasks 的內容

- 可驗收的任務（明確的完成定義）
- 適當粒度（0.5-2 天可完成）
- 依賴關係清晰
- **做什麼**，而非**怎麼做**

範例：
```markdown
- [ ] 實作 CommandHandler 處理訂單建立
  - 依賴：OrderCommand 已定義
  - 驗收：通過單元測試，訂單可正確建立

- [ ] 實作 QueryHandler 處理訂單查詢
  - 依賴：ReadModel 已建立
  - 驗收：通過整合測試，查詢回應時間 < 100ms
```

#### ✅ 應該寫在 Templates 的內容

- 可重複使用的操作步驟
- 框架特定的實作範式
- 程式碼範例與樣板
- 常見陷阱與注意事項
- 檢查清單

範例：
```markdown
## CQRS Command Handler 實作步驟

### 1. 建立 Command 類別
\`\`\`php
class CreateOrderCommand
{
    public function __construct(
        public readonly string $userId,
        public readonly array $items
    ) {}
}
\`\`\`

### 2. 建立 Handler
\`\`\`php
class CreateOrderHandler
{
    public function handle(CreateOrderCommand $command): Order
    {
        // 實作邏輯
    }
}
\`\`\`

### 3. 註冊 Handler
在服務提供者中註冊...

### 常見錯誤
- ❌ 在 Command 內包含業務邏輯
- ✅ Command 只應是資料容器
```

---

## 📖 第五部分：實踐流程

### 5.1 從零開始的文件創建流程

```
1. 建立/更新憲法（一次性，除非團隊原則改變）
   ↓
2. 建立可重複使用的模板（累積性）
   ↓
3. 為新功能撰寫 Spec
   ↓
4. 基於 Spec + 憲法 + 模板，生成 Plan
   ↓
5. 基於 Plan，生成 Tasks
   ↓
6. 執行 Tasks（實作階段）
   ↓
7. 分析一致性（Spec ↔ Plan ↔ Tasks）
```

### 5.2 整理既有文件的流程

當你有一份混合的參考文件時：

```
1. 通讀文件，標記每段內容類型
   [P] 原則 / [B] 最佳實務 / [S] 步驟 / [E] 範例

2. 提取 MUST 級原則 → 加入 Constitution

3. 提取可重複流程與範例 → 建立 Template

4. 確認當前功能特定需求 → 寫入 Plan

5. 將功能需求拆解為任務 → 寫入 Tasks

6. 建立檢查清單 → 放入 Checklist
```

### 5.3 快速決策樹

當你不確定某段內容該放哪裡時：

```
這是原則嗎？
├─ 是 → 可以被功能覆寫嗎？
|       ├─ 不可 → Constitution
|       └─ 可以 → Templates (標註 SHOULD)
└─ 否 → 是可重複使用的嗎？
        ├─ 是 → Templates
        └─ 否 → 是設計決策嗎？
                ├─ 是 → Plan
                └─ 否 → Tasks
```

---

## 📊 總結對照表

| 文件類型 | 內容類型 | 時效性 | 讀者 | 範例標題 |
|---------|---------|--------|------|---------|
| **Constitution** | 不可協商的團隊原則 | 長期穩定 | 全團隊 | "測試驅動開發原則" |
| **Templates** | 可重複使用的模式 | 定期更新 | 開發者 | "API 端點實作範式" |
| **Plan** | 功能設計與決策 | 單一功能 | 功能團隊 | "訂單管理系統設計" |
| **Tasks** | 可驗收的工作項目 | 單一功能 | 執行者 | "實作訂單建立 API" |
| **Checklist** | 品質檢查點 | 可重複使用 | 審查者 | "API 上線前檢查清單" |

---

## 🎓 關鍵要點

1. **憲法是原則，不是手冊**
   - 只放 MUST 級規範
   - 保持簡潔，不超過 2-3 頁

2. **模板是教學，不是規範**
   - 提供指導與範例
   - 可以被覆寫或調整

3. **Plan 是設計，不是步驟**
   - 說明「為什麼」和「怎麼設計」
   - 不包含操作細節

4. **Tasks 是任務，不是教程**
   - 描述「做什麼」
   - 不說明「怎麼做」

5. **分層的目的是重用與一致性**
   - 憲法確保底線
   - 模板提升效率
   - Plan 保證設計品質
   - Tasks 確保可執行性

---

## 📚 延伸閱讀

- `/memory/constitution.md` - 憲法範本
- `/templates/plan.md` - 計畫範本
- `/templates/tasks.md` - 任務範本
- `/templates/commands/analyze.md` - 一致性分析流程

---

**版本**: 1.0
**更新日期**: 2025-11-24
**維護者**: SDD 工作流程委員會
